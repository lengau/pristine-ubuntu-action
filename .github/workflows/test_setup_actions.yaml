# .github/workflows/test_setup_actions.yaml
name: Test Setup Actions
on:
  push:
    branches:
      - main
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup-works:
    strategy:
      matrix:
        os:
          - ubuntu-22.04
          - ubuntu-22.04-arm
          - ubuntu-24.04
          - ubuntu-24.04-arm
      fail-fast: false
    runs-on: ${{ matrix.os }}
    name: Actions work (${{ matrix.os }})
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Clean Ubuntu
        if: ${{ runner.environment == 'github-hosted' }}
        uses: ./ # Uses an action in the root directory

      - name: Wait for all deletions to complete
        run: |
          while pgrep -x rm; do
            sleep 1
          done

      # Check that setup jobs still work
      - name: Setup go (v5)
        uses: actions/setup-go@v5
      - name: Setup go (v6)
        uses: actions/setup-go@v5
      - name: Setup dotnet (v4)
        uses: actions/setup-dotnet@v4
      - name: Setup dotnet (v5)
        uses: actions/setup-dotnet@v5
      - name: Setup java (v4)
        uses: actions/setup-java@v4
        with:
          distribution: microsoft
          java-version: 25
      - name: Setup java (v5)
        uses: actions/setup-java@v5
        with:
          distribution: microsoft
          java-version: 21
      - name: Setup node (v4)
        uses: actions/setup-node@v4
      - name: Setup node (v5)
        uses: actions/setup-node@v5
      - name: Setup node (v6)
        uses: actions/setup-node@v6
      - name: Setup python (v4)
        uses: actions/setup-python@v4
      - name: Setup python (v5)
        uses: actions/setup-python@v5
      - name: Setup python (v6)
        uses: actions/setup-python@v6

      # Test checkout actions
      - name: Test checkout v2
        uses: actions/checkout@v2
      - name: Test checkout v3
        uses: actions/checkout@v3
      - name: Test checkout v4
        uses: actions/checkout@v4

      # Test cache actions
      - name: Test cache v3
        uses: actions/cache@v3
        with:
          path: ~/.cache/test
          key: test-${{ runner.os }}-${{ github.sha }}
      - name: Test cache v4
        uses: actions/cache@v4
        with:
          path: ~/.cache/test2
          key: test2-${{ runner.os }}-${{ github.sha }}

      # Test upload/download artifact actions
      - name: Test upload-artifact v4
        uses: actions/upload-artifact@v4
        with:
          name: test-artifact-v4-${{ matrix.os }}
          path: test-artifact.txt

      # Test setup actions
      - name: Test setup-go v5
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'
      - name: Verify go works
        run: go version

      - name: Test setup-node v4
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Verify node works
        run: node --version

      - name: Test setup-python v5
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Verify python works
        run: python --version

      - name: Test setup-java v4
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      - name: Verify java works
        run: java -version

      - name: Test setup-dotnet v4
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'
      - name: Verify dotnet works
        run: dotnet --version

      # Test Docker actions
      - name: Test docker/setup-buildx-action v3
        uses: docker/setup-buildx-action@v3
      - name: Test docker/setup-qemu-action v3
        uses: docker/setup-qemu-action@v3
      - name: Test docker/metadata-action v5
        uses: docker/metadata-action@v5
        with:
          images: test/test

      # Test GitHub CLI actions
      - name: Test github-script v7
        uses: actions/github-script@v7
        with:
          script: |
            console.log('GitHub Script works!')
            return true

      # Test labeler action
      - name: Test labeler v5
        uses: actions/labeler@v5
        continue-on-error: true

      # Test stale action
      - name: Test stale v9
        uses: actions/stale@v9
        continue-on-error: true
        with:
          days-before-stale: 90
          days-before-close: 30

      # Test dependency review
      - name: Test dependency-review-action v4
        uses: actions/dependency-review-action@v4
        continue-on-error: true

      # Test CodeQL (popular security scanning action)
      - name: Test github/codeql-action/init v3
        uses: github/codeql-action/init@v3
        continue-on-error: true
        with:
          languages: javascript

      # Test popular third-party actions
      - name: Test actions-rust-lang/setup-rust-toolchain v1
        uses: actions-rust-lang/setup-rust-toolchain@v1
        continue-on-error: true
      - name: Verify rust works (if installed)
        run: rustc --version || true

      - name: Test ruby/setup-ruby v1
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
      - name: Verify ruby works
        run: ruby --version

      - name: Test pnpm/action-setup v4
        uses: pnpm/action-setup@v4
        with:
          version: 8
      - name: Verify pnpm works
        run: pnpm --version

      - name: Test gradle/actions/setup-gradle v4
        uses: gradle/actions/setup-gradle@v4
      - name: Verify gradle works
        run: gradle --version

      - name: Test aws-actions/configure-aws-credentials v4
        uses: aws-actions/configure-aws-credentials@v4
        continue-on-error: true
        with:
          aws-region: us-east-1

      - name: Test azure/login v2
        uses: azure/login@v2
        continue-on-error: true

      - name: Test google-github-actions/auth v2
        uses: google-github-actions/auth@v2
        continue-on-error: true

      # Test coverage actions
      - name: Test codecov/codecov-action v4
        uses: codecov/codecov-action@v4
        continue-on-error: true

      - name: Test coverallsapp/github-action v2
        uses: coverallsapp/github-action@v2
        continue-on-error: true

      # Test deployment actions
      - name: Test actions/deploy-pages v4
        uses: actions/deploy-pages@v4
        continue-on-error: true

      - name: Test peaceiris/actions-gh-pages v4
        uses: peaceiris/actions-gh-pages@v4
        continue-on-error: true
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .

      # Test container actions
      - name: Test docker/login-action v3
        uses: docker/login-action@v3
        continue-on-error: true

      - name: Test docker/build-push-action v6
        uses: docker/build-push-action@v6
        continue-on-error: true
        with:
          push: false

      # Verify basic git operations still work
      - name: Test git operations
        run: |
          git config user.name "Test User"
          git config user.email "test@example.com"
          echo "test" > test-git.txt
          git add test-git.txt
          git commit -m "Test commit" || true

      # Final verification
      - name: Check disk space at end
        if: always()
        run: |
          df -h
